define("home:widget/shopping_confirm/shopping_confirm.js", function (t, e, a) { var n = t("common:widget/plugin/dialog/dialog.js"); ({ init: function (t) { var e = this; e.items = e.getQueryString().items, e.$body = $("body"), e.$J_addaddress = $("#J_addaddress"), e.$J_addressbox = $("#J_addressbox"), e.$J_additem = $("#J_additem"), e.$J_canceladdbtn = $("#J_canceladdaddressbtn"), e.$J_addaddressbtn = $("#J_addaddressbtn"), e.$J_modaddressbtn = $("#J_modaddressbtn"), e.$J_subaddress = $("#J_subaddress"), e.$J_openAddresses = $("#J_openAddresses"), e.$deladdressbtn = $(".deladdressbtn"), e.$modaddressbtn = $(".modaddressbtn"), e.$J_province = $("#J_province"), e.$J_city = $("#J_city"), e.$J_street = $("#J_street"), e.$addcon = $(".addcon"), e.$provinceContent = $(".province-content"), e.$cityContent = $(".city-content"), e.$streetContent = $(".street-content"), e.$addressitem = $(".addressitem"), e.$edit = $(".btngroup"), e.$input_country = $("#input_country"), e.$input_province = $("#input_province"), e.$input_city = $("#input_city"), e.$input_district = $("#input_district"), e.$input_addressName = $("#input_addressName"), e.$input_provinceLocalName = $("#input_provinceLocalName"), e.$input_cityLocalName = $("#input_cityLocalName"), e.$input_districtLocalName = $("#input_districtLocalName"), e.$sele_input_province = $(".sele-input-province"), e.$sele_input_city = $(".sele-input-city"), e.$sele_input_street = $(".sele-input-street"), e.$input_taitou = $("#input_taxTitle"), e.$input_taxCompany = $("#input_taxCompany"), e.$goapply = $("#goapply"), e.$taitou = $(".taitou"), e.$T_province = $("#T_province"), e.$T_city = $("#T_city"), e.$T_street = $("#T_street"), e.$dianzi_des = $(".dianzi_des"), e.$input_taxTitle_remark = $("#input_taxTitle_remark"), e.addressConf = { abbreviation: "", country: "", city: "" }, e.addressName = t.fullName, e.productID = null, e.orderConf = { addressId: t.fid, fulfillmentType: "1001", lineItems: [], taxItems: [{ taxTitle: window.fullName, taxType: 3, taxCompany: "", invoiceRemark: "" }], voucherId: window.youhuiquancode }, e.globalCart = window.globalCart; for (var a = 0; a < e.globalCart.length; a++) e.orderConf.lineItems.push({ skuId: e.globalCart[a].skuId + "", quantity: parseInt(e.globalCart[a].quantity) }); e.event(), e.serializeObject() }, serializeObject: function () { $.fn.serializeObject = function () { var t = {}, e = this.serializeArray(); return $.each(e, function () { t[this.name] ? (t[this.name].push || (t[this.name] = [t[this.name]]), t[this.name].push(this.value || "")) : t[this.name] = this.value || "" }), t } }, event: function () { var t = this; t.$body.on("click", function () { t.$addcon.hide() }); var e = 0; t.$J_openAddresses.click(function () { e++ % 2 == 0 ? (t.$addressitem.css("display", "block"), $(this).text("收起收货地址").addClass("opened")) : (t.$addressitem.each(function () { $(this).index() > 2 && $(this).css("display", "none") }), $(this).text("展开收货地址").removeClass("opened")) }), t.select("address", function (e, a) { e.removeClass("onselect"), a.addClass("onselect"), t.orderConf.addressId = a.data("id") + "", t.addressName = a.data("name"), t.orderConf.taxItems[0].taxTitle = a.data("name"), $(".fapiaotaitou").val(a.data("name")) }), t.select("time", function (e, a) { e.removeClass("onselect"), a.addClass("onselect"), t.orderConf.fulfillmentType = a.data("fulfillmenttype") + "" }), t.select("fapiaotype", function (e, a) { e.removeClass("onselect"), a.addClass("onselect"); var n = a.data("taxtype"); if ("1" == n) { var o = $(".putongfapiao").find(".onselect").data("taxtype"); t.orderConf.taxItems[0].taxType = o, $(".putongfapiao").removeClass("hide"), $(".dianzifapiao").addClass("hide"), $(".dianzi_des").addClass("hide") } else { var o = $(".dianzifapiao").find(".onselect").data("taxtype"); t.orderConf.taxItems[0].taxType = o, $(".dianzifapiao").removeClass("hide"), $(".putongfapiao").addClass("hide"), $(".dianzi_des").removeClass("hide") } t.taxCompanyInput(t.orderConf.taxItems[0].taxType) }), t.select("fapiao", function (e, a) { e.removeClass("onselect"), a.addClass("onselect"), t.orderConf.taxItems[0].taxType = a.data("taxtype"), 2 == a.data("taxtype") ? ($(".fapiaotaitou").val("").attr("placeholder", "请填写单位名称"), t.orderConf.taxItems[0].taxTitle = "") : ($(".fapiaotaitou").val(t.addressName).attr("placeholder", "为了方便上牌照，请您填写真实姓名"), t.orderConf.taxItems[0].taxTitle = t.$input_taitou.val()), t.taxCompanyInput(t.orderConf.taxItems[0].taxType) }), t.select("fapiao2", function (e, a) { e.removeClass("onselect"), a.addClass("onselect"), t.orderConf.taxItems[0].taxType = a.data("taxtype"), t.orderConf.taxItems[0].taxTitle = "", 4 == a.data("taxtype") ? $(".fapiaotaitou").val("").attr("placeholder", "请填写单位名称") : ($(".fapiaotaitou").val(t.addressName).attr("placeholder", "为了方便上牌照，请您填写真实姓名"), t.orderConf.taxItems[0].taxTitle = t.$input_taitou.val()), t.taxCompanyInput(t.orderConf.taxItems[0].taxType) }), t.$input_taitou.on("keyup", function () { var e = $(this); t.orderConf.taxItems[0].taxTitle = $.trim(e.val()) }), t.$input_taxCompany.on("keyup", function () { var e = $(this); t.orderConf.taxItems[0].taxCompany = $.trim(e.val()) }), t.$J_additem.on("click", function () { t.addStatus() }), t.$J_canceladdbtn.on("click", function () { t.cancelStatus() }), t.$addressitem.on("mouseenter", function () { $(this).find(".btngroup").show() }).on("mouseleave", function () { $(this).find(".btngroup").hide() }), t.$T_province.on("click", function () { var e = $(this); t.addressConf.abbreviation !== e.data("abbreviation") && (t.$sele_input_city.val(""), t.$sele_input_street.val("")), t.$sele_input_province.trigger("focus"), t.addressConf.abbreviation = e.data("abbreviation"), t.addressConf.country = e.data("country"), t.$sele_input_province.val(e.text()), t.$input_provinceLocalName.val(e.text()), t.$input_province.val(e.data("abbreviation")), t.$provinceContent.hide() }), t.$T_city.on("click", function () { var e = $(this); t.addressConf.city !== e.data("city") && t.$sele_input_street.val(""), t.$sele_input_city.trigger("focus"), t.addressConf.city = e.data("city"), t.$sele_input_city.val(e.text()), t.$input_cityLocalName.val(e.text()), t.$input_city.val(e.data("city")), t.$cityContent.hide() }), t.$T_street.on("click", function () { var e = $(this); t.$sele_input_street.trigger("focus"), t.$sele_input_street.val(e.text()), t.$input_districtLocalName.val(e.text()), t.$input_district.val(e.data("street")), t.$streetContent.hide() }), t.$J_province.on("click", function () { t.$addcon.hide(), t.$sele_input_province.trigger("focus"), t.remote("/api/address/province", {}, function (e) { T().clear(!0).target(".province-content").template("#T_province").list(e).doEach(function (t, e, a) { a.attr("data-abbreviation", e.abbreviation), a.attr("data-country", e.country), a.text(e.localName) }), t.$provinceContent.show() }) }), t.$J_city.on("click", function () { return t.$addcon.hide(), t.$sele_input_city.trigger("focus"), t.addressConf.abbreviation ? void t.remote("/api/address/city", { province: t.addressConf.abbreviation }, function (e) { return 0 == e.length ? (n.alert("此地暂送不到,请您更换修改地址"), !1) : (T().clear(!0).target(".city-content").template("#T_city").list(e).doEach(function (t, e, a) { a.attr("data-city", e.name), a.attr("data-state", e.state), a.text(e.localName) }), void t.$cityContent.show()) }) : (t.$J_province.trigger("click"), !1) }), t.$J_street.on("click", function () { return t.$addcon.hide(), t.$sele_input_street.trigger("focus"), t.addressConf.abbreviation ? t.addressConf.city ? void t.remote("/api/address/district", { province: t.addressConf.abbreviation, city: t.addressConf.city }, function (e) { return 0 == e.length ? (n.alert("抱歉！此地区暂时无法送达"), !1) : (T().clear(!0).target(".street-content").template("#T_street").list(e).doEach(function (t, e, a) { a.removeClass("hide"), a.text(e.localName), a.attr("data-street", e.name) }), void t.$streetContent.show()) }) : (t.$J_city.trigger("click"), !1) : (t.$J_province.trigger("click"), !1) }), t.$J_addaddressbtn.on("click", function () { if (!t.$J_subaddress.validation()) return !1; var e = t.$J_subaddress.serializeObject(); t.remote("/api/address/add", e, function (t) { "ok" == t.message ? window.location.reload() : n.alert(t.message) }) }), t.$deladdressbtn.on("click", function () { t.productID = $(this).data("id"), n.confirm({ title: "删除地址", content: "确定要删除此地址吗？", leftBtn: "取消", rightBtn: "确定:!", rightBtnCallback: function () { $.ajax({ type: "post", url: "/api/address/del", data: { id: t.productID }, dataType: "json", success: function (t) { return t.head && "999999" == t.head.rtnCode ? (G_gologin(), !1) : void ("ok" == t.message && window.location.reload()) } }) } }) }), t.$modaddressbtn.on("click", function () { var e = $(this).data("id"); t.remote("/api/address/getone", { id: e }, function (a) { t.bindaddress(a, e), t.addressConf.abbreviation = a.address.addressInfo.subDivision, t.addressConf.country = a.address.addressInfo.country, t.addressConf.city = a.address.addressInfo.city, t.modStatus() }) }), t.$J_modaddressbtn.on("click", function () { if (!t.$J_subaddress.validation()) return !1; var e = t.$J_subaddress.serializeObject(); t.remote("/api/address/mod", e, function (t) { return t.head && "999999" == t.head.rtnCode ? (G_gologin(), !1) : void ("ok" == t.message && window.location.reload()) }) }), t.$goapply.on("click", function () { if (0 == t.orderConf.addressId) return window.scrollTo(0, 0), n.alert("请选择一个地址，或者添加地址"), !1; if (0 == t.orderConf.lineItems.length) return window.scrollTo(0, 0), n.alert("您的购物车没有东西，请先去添加购物车吧", function () { window.location.href = "/cart" }), !1; if ("" == t.orderConf.taxItems[0].taxTitle) return window.scrollTo(0, 900), n.alert("请您填写发票抬头"), !1; if (2 == t.orderConf.taxItems[0].taxType || 4 == t.orderConf.taxItems[0].taxType) { if ("" == t.orderConf.taxItems[0].taxCompany) return window.scrollTo(0, 900), n.alert("请您填写企业税号"), !1; if (t.orderConf.taxItems[0].taxCompany = t.orderConf.taxItems[0].taxCompany.toUpperCase(), !/^[A-Z0-9]{15}$|^[A-Z0-9]{17}$|^[A-Z0-9]{18}$|^[A-Z0-9]{20}$/.test(t.orderConf.taxItems[0].taxCompany)) return n.alert("企业税号格式不正确"), window.scrollTo(0, 900), !1 } else t.orderConf.taxItems[0].taxCompany = "", t.$input_taxCompany.val(""); if (3 == t.orderConf.taxItems[0].taxType || 4 == t.orderConf.taxItems[0].taxType) { if (!$(".fapiaoemail").validation()) return !1; t.orderConf.taxItems[0].invoiceRemark = $(".fapiaoemail").val() } t.orderConf.voucherId = window.youhuiquancode || "", $.ajax({ type: "post", url: "/api/order/create", data: { order: t.orderConf, items: t.items }, dataType: "json", success: function (e) { if (e.head && "999999" == e.head.rtnCode) return G_gologin(), !1; var a = e.orderId; e.rtnCode && "500" == e.rtnCode ? (window.scrollTo(0, 0), n.alert(e.message, function () { window.location.href = "/cart" })) : e.rtnCode && "501" == e.rtnCode ? (window.scrollTo(0, 0), n.alert(e.message)) : e.status && "CREATED" == e.status ? (t.orderConf.lineItems = [], window.location.href = "/order/pay?id=" + a) : n.alert("订单创建失败!", function () { window.location.href = "/cart" }) }, error: function () { } }) }) }, taxCompanyInput: function (t) { 2 == t || 4 == t ? $(".taxcompany").removeClass("hide") : $(".taxcompany").addClass("hide") }, getQueryString: function () { var t = location.search, e = new Object; if (-1 != t.indexOf("?")) { var a = t.substr(1); strs = a.split("&"); for (var n = 0; n < strs.length; n++) e[strs[n].split("=")[0]] = strs[n].split("=")[1] } return e }, clearCart: function (t) { var e = this; $.ajax({ type: "post", url: "/api/cart/clear", dataType: "json", success: function (a) { return a.head && "999999" == a.head.rtnCode ? (G_gologin(), !1) : void ("created" == a.message && (e.orderConf.lineItems = [], t())) }, error: function () { } }) }, addStatus: function () { var t = this; t.$J_subaddress[0].reset(), t.$J_addaddress.show(), t.$J_addressbox.hide(), t.$J_addaddressbtn.css("display", "inline-block"), t.$J_modaddressbtn.hide() }, modStatus: function () { var t = this; t.$J_addaddress.show(), t.$J_addressbox.hide(), t.$J_addaddressbtn.hide(), t.$J_modaddressbtn.css("display", "inline-block") }, cancelStatus: function () { var t = this; t.$J_addaddress.hide(), t.$J_addressbox.show() }, bindaddress: function (t, e) { var a = this; $("#input_fullName").val(t.address.fullName), $("#input_mobile").val(t.address.mobile), $("#input_phone").val(t.address.phone), $("#input_emailAddress").val(t.address.emailAddress), a.$input_addressName.val(t.address.addressName), a.$sele_input_province.val(t.address.addressInfo.subDivisionLocalName), a.$sele_input_city.val(t.address.addressInfo.cityLocalName), a.$sele_input_street.val(t.address.addressInfo.districtLocalName), a.$input_provinceLocalName.val(t.address.addressInfo.subDivisionLocalName), a.$input_cityLocalName.val(t.address.addressInfo.cityLocalName), a.$input_districtLocalName.val(t.address.addressInfo.districtLocalName), $("#input_addressId").val(e), $("#input_isDefault").prop("checked", t.address.isDefault), a.$input_province.val(t.address.addressInfo.subDivision), a.$input_city.val(t.address.addressInfo.cityLocalName), a.$input_district.val(t.address.addressInfo.districtLocalName), $("#input_addressLine1").val(t.address.addressLine.addressLine1), $("#input_postalCode").val(t.address.postalCode) }, select: function (t, e) { var a = t.split(" "); $.each(a, function (t, a) { var n = $("*[group='" + a + "']"); n.on("click", function () { e(n, $(this)) }) }) }, setAddressDefault: function (t) { var e = this; e.remote("/api/address/default", { id: t }, function () { }) }, remote: function (t, e, a) { $.ajax({ type: "post", url: t, data: e, dataType: "json", success: function (t) { return t.head && "999999" == t.head.rtnCode ? (G_gologin(), !1) : void a(t) }, error: function () { } }) } }).init(window), a.exports = { init: function () { var t = this; t.items = t.getQueryString().items, t.$confirmCouponSelect = $(".confirm-coupon-select"), t.$couponSelectInput = $(".coupon-select-input"), t.$couponContent = $(".coupon-content"), t.$couponItem = $(".couponItem"), t.$couponcardimg = $("#couponcardimg"), t.$checkcoupon = $("#checkcoupon"), t.$coupon = $(".couponinput"), t.$couponcard = $(".couponcard"), t.$yingfujine = $(".yingfujine"), t.$youhuiquan = $(".youhuiquan"), t.event() }, event: function () { var t = this; t.$checkcoupon.on("click", function () { var e = t.$coupon.val(); t.verifyCode(e, function (a) { a ? (t.setLottery(a), window.youhuiquancode = e) : n.alert("优惠券无效，请重新输入"), t.$couponContent.hide() }) }), t.$couponItem.on("click", function () { var e = $(this), a = e.data("code"); t.verifyCode(a, function (e) { e ? (t.setLottery(e), window.youhuiquancode = a) : n.alert("优惠券无效或已使用") }), t.$couponContent.hide() }), t.$couponSelectInput.on("click", function () { "none" == t.$couponContent.css("display") ? t.$couponContent.show() : t.$couponContent.hide() }) }, setLottery: function (t) { var e = this; e.$couponSelectInput.val(t.orderPrice.OFFER + "元优惠券"), $(".J_itemTotal").html("商品合计：" + t.orderPrice.ITEMS_TOTAL + "元"), $(".J_shippingTotal").html("配送费用：" + t.orderPrice.SHIPPING_TOTAL + "元"), $(".J_orderTotal").html("费用总计：" + t.orderPrice.ORDER_TOTAL + "元"), $(".J_shipping").html("优惠金额：-" + t.orderPrice.OFFER + "元") }, verifyCode: function (t, e) { var a = this; a.remote("/api/coupon/orderprice", { code: t, items: a.items }, function (t) { if (console.log(t), 500 == t.status) n.alert("请稍候重试"); else if (405 == t.status) n.alert("购物车为空", function () { window.location.href = "/cart" }); else { if (0 == t.orderPrice.OFFER) return n.alert(t.orderPrice.OFFER_MESSAGE || "优惠券无效"), !1; e(t) } }) }, remote: function (t, e, a) { $.ajax({ type: "post", url: t, data: e, dataType: "json", success: function (t) { return t.head && "999999" == t.head.rtnCode ? (G_gologin(), !1) : void a(t) }, error: function () { } }) }, getQueryString: function () { var t = location.search, e = new Object; if (-1 != t.indexOf("?")) { var a = t.substr(1); strs = a.split("&"); for (var n = 0; n < strs.length; n++) e[strs[n].split("=")[0]] = strs[n].split("=")[1] } return e } } });